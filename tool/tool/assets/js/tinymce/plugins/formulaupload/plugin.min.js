(function() {
    tinymce.create('tinymce.plugins.FormulaUploadPlugin', {
        init : function(ed, url) {
            url = tinyMCE.activeEditor.getParam('formulaupload_rel') || url;
            var formulaUploadUrl = tinyMCE.activeEditor.getParam('formulaupload_url');
            var head = document.getElementsByTagName('body')[0];
            var css = document.createElement('link');                       
            css.type = 'text/css';
            css.rel = 'stylesheet';
            css.href = url + '/css/style.css';
            head.appendChild(css);
			
			ed.addCommand('mceFormulaUpload', function(e,args,f) {
                $('#formula_upload_type').val('tinymce'); 
                $('body').append('<div class="formulaUploadBg"></div>');
            
                var removeForeground = function() {
                    $('.formulaUploadFg').remove();
                    $('.formulaUploadFgLoading').remove();
                };
				
                var removeBackground = function() {
                    $('.formulaUploadBg').remove();
                    $('.formulaUploadContainer').remove();
                };
				
				var loadContent = function(id, SID, design, language) {
					if (this.targetSize > 0) {
						this.targetArray = new Array();
						this.targetSize = 0;
						this.targetArea = null;
						this.curTarget = 0;
					}
					//if (this.editor_id != id) {
						this.editor_id = id;
						var url = EMBED_ENGINE + '?id=' + id + '&SID=' + SID + '&design=' + design;
						if (language != undefined && language != '')
							url += '&lang=' + language;
						var fileref = document.createElement('script');
						fileref.setAttribute("type", "text/javascript");
						fileref.setAttribute("src", url);
						document.getElementsByTagName("head")[0].appendChild(fileref);
					//}
				};
			
			    var container = '\
				<div class="formulaUploadContainer mce-container mce-panel mce-window">\
                        <div class="formulaUploadContainerInner">\
                            <div class="mce-window-head">\
                                <div class="mce-title">Formula Uploader</div>\
                                <button type="button" class="mce-close">X</button>\
                            </div>\
							<div class="mce-container toolbarContainer stdContainer">\
								<div id="toolbar"></div>\
							</div>\
                            <div class="mce-container formulaTextContainer stdContainer" hidefocus="1" tabindex="-1">\
                                <div class="mce-container-body">\
                                    <textarea style="height:150px;width:97%" name="formula" id="formulaText"></textarea>\
                                </div>\
							</div>\
							<div class="mce-container prContainerHeader" hidefocus="1" tabindex="-1">\
                                <div class="mce-window-head">\
									<div class="mce-title">Formula Preview</div>\
								</div>\
						    </div>\
							<div class="prContainer stdContainer" style="overflow-y:auto;">\
								<img src="" name="prFormula" id="prFormula"/>\
							</div>\
							<div class="formulaUploadConfirmCase mce-panel">\
                                <div class="mce-btn mce-primary">\
                                    <button role="presentation" class="formulaUploadSubmit">Upload</button>\
                                </div>\
                                <div class="mce-btn">\
                                    <button role="presentation" class="formulaUploadClose">Close</button>\
                                </div>\
                            </div>\
                        </div>\
                    </div>\
                ';
                
                $('body').append(container);
				loadContent.call(EqEditor);
				EqEditor.add(new EqTextArea('prFormula', 'formulaText'),false); 
				
                $('.formulaUploadBg, .formulaUploadContainer .formulaUploadClose, .mce-close').on('click', function(){
                    removeForeground();
                    removeBackground();
                });
				
				$('#formulaText').on('change',function(val){
					var value = $(this).val();
					if($.isEmptyObject(value)){
						$('#prFormula').attr('src','');
					}
				});
				
				if(args){
					var inputForm = $(args);
					$('#prFormula').attr('src',inputForm.attr("src"));
					$('#formulaText').val(unescape(inputForm.attr("text")));
				}
				
                $('.formulaUploadSubmit').on('click', function(){
						var textVal = $('#formulaText').val();
						var val = $('#prFormula').attr('src');
						if (textVal) {
							textVal  = escape(textVal);
							if(args){
								var inputForm = $(args);
								var content = ed.getContent();
								var oldVal = inputForm.attr("src");
								if(oldVal != val){
									var oldText = inputForm.attr("text");
									if(oldVal.indexOf(EQUATION_ENGINE) == -1){
										content = content.replace(".."+oldVal,val); // TBD:Ananth
									}
									
									content = content.replace(oldVal,val);
									content = content.replace(oldText,textVal);
									ed.setContent(content);
								}
							}else{
								var tpl = '<img src="%s"  text="%y""/>';
								tpl = tpl.replace('%s', val);
								tpl = tpl.replace('%y', textVal);
								ed.insertContent(tpl);	
							}
							ed.focus();
						}
						removeForeground();
						removeBackground();
                   });

            });
            // Register buttons
            ed.addButton('formulaupload', {
                title : 'Formula Upload',
                cmd : 'mceFormulaUpload',
                image : url + '/img/icon.png'
            });
        },
		

        getInfo : function() {
            return {
                longname : 'Image Upload',
                author : 'Ananth',
                version : '1.0.0'
            };
        }
    });
    
    tinymce.PluginManager.add('formulaupload', tinymce.plugins.FormulaUploadPlugin);
})();